<!DOCTYPE html><html>

<head>
<meta charset="utf-8">
<title>Interfaces_in-the-small-and-large</title>
<style type="text/css">
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>
<style type="text/css">
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', monospace;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #a67f59;
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
</style>
<style type="text/css">
pre.line-numbers {
	position: relative;
	padding-left: 3.8em;
	counter-reset: linenumber;
}

pre.line-numbers > code {
	position: relative;
}

.line-numbers .line-numbers-rows {
	position: absolute;
	pointer-events: none;
	top: 0;
	font-size: 100%;
	left: -3.8em;
	width: 3em; /* works for line-numbers below 1000 lines */
	letter-spacing: -1px;
	border-right: 1px solid #999;

	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;

}

	.line-numbers-rows > span {
		pointer-events: none;
		display: block;
		counter-increment: linenumber;
	}

		.line-numbers-rows > span:before {
			content: counter(linenumber);
			color: #999;
			display: block;
			padding-right: 0.8em;
			text-align: right;
		}
</style>
</head>
<body>
<h1 id="toc_0">RESTful Interfaces in the Small and in the Large</h1>

<p>This post outlines an architecture strategy to desing-in-the-small standarized components - just following the <em>D&#39;ont Repeat Yourself (DRY)</em> principle - and to scale them for whole application landscapes. </p>

<h2 id="toc_1">Introduction</h2>

<h3 id="toc_2">Problem</h3>

<p>At the beginning, we often implement a few interfaces. The number of interfaces grows then over time significantly. Interface implementations are often representing a significant percentage of the code base and hence costs.  </p>

<p>What <strong>architectures strategies</strong> for implementing interfaces provide <em>economies of scale</em> and facilitate the transition from the <em>programming-in-the-small</em> to the <em>programming-in-the-large</em>? </p>

<h3 id="toc_3">Solution</h3>

<p>The solution, which I present here, is based on the following principles</p>

<ul>
<li><p>Adopt early on <em>design patterns</em> to standardize the design;</p></li>
<li><p>Use the programming-language&rsquo;s <em>interface</em> to decouple the pattern elements; and</p></li>
<li><p>Generalize pattern elements to re-use them across the board. </p></li>
</ul>

<p>This is nothing new per se. But, the interesting twist is how to start programming- in-the-small and evolve the design to one that fits for programming-in-the-large. This requirement rules out strategies requiring a large initial investment.</p>

<p>As a case study, I show how to apply these principles to the  implementation of RESTful interfaces in the programming language Clojure. Clojure offers offers an interface notion, called <em>protocols</em>, and a <em>macro</em> mechanism that facilitates the generalization and re-use. As a design pattern, we use the  <em>Model-View-Controller (MVC)</em> design pattern []. For a brief summary of concepts, see Appendix. </p>

<h2 id="toc_4">The Solution</h2>

<p>Here, I use a simplified example for explantory purposes. In particular, the functional scope is limited and data storage, security features and so on are omitted. The evoluationary design is outlined by a series of mini-tutorials for this example, which are available on <a href="https://github.com/glgit/tutorial/">here</a>. </p>

<p>An Interface Component provides in our case just</p>

<ul>
<li><p>A set of RESTful interfaces with  their <em>resources</em> and <em>methods</em>.  For instance, a resource currency <code>account</code> providing a <code>GET</code> method that accepts an account identifier and returns , if the cller is authorized,  the account data in JSON. </p></li>
<li><p>A mocked data set that the RESTful interfaces are delivering </p></li>
</ul>

<h2 id="toc_5">Implementing a simple interface</h2>

<h3 id="toc_6">Hello World Example</h3>

<p>In Clojure, the library  <a href="https://github.com/ring-clojure/ring">ring</a> and <a href="https://github.com/weavejester/compojure">compojure</a>      enable to define interfaces and <em>end-points</em> in terms of <em>routes</em> and their run-time context.  </p>

<p>As an example, I use these libraries to implement an interface that delivers a static HTML page. This is our &ldquo;hello world&rdquo; example to get started.</p>

<pre class="line-numbers"><code class="language-Clojure">(defn home
  &quot;Function returning a static html page&quot;
  [req]
  (render (io/resource &quot;index.html&quot;) req))

(defroutes app-routes
  &quot;Defined routes of the application&quot;
  (GET &quot;/&quot; [] home)               ;; home-page
  (route/resources &quot;/&quot; )          ;; resources required 
  (route/not-found &quot;Not found&quot;))  ;; exception case
  
(def handler
  &quot;Handler chain invokved on a request by the server&quot;
  (-&gt; app-routes
      wrap-params))</code></pre>

<p>The handler is passed to the <a href="http://www.eclipse.org/jetty/">Jetty</a> webserver at start-up time (the details are found in the <a href="https://github.com/glgit/tutorial/blob/master/ex1/project.clj"><code>project.clj</code></a> configuration file under <code>:ring</code>). The example is available <a href="https://github.com/glgit/tutorial/tree/master/ex1">here</a>.</p>

<h3 id="toc_7">A First Interface getAccounts</h3>

<p>First, we define example data.  For this purpose, we simply declare  an immutable map of accounts, where each account is described by a map too. Here, just a single account with three credit and debit bookings.  </p>

<pre class="line-numbers"><code class="language-Clojure">(def account-test-data
    {:101 {:account-id 101 :currency &quot;CHF&quot; 
     :bookings[ {:amount 100  :value-date &quot;2014-01-02&quot; :ccy &quot;CHF&quot; :xref &quot;A1&quot;}
                {:amount -100 :value-date &quot;2014-01-02&quot; :ccy &quot;CHF&quot; :xref &quot;A2&quot;}
                {:amount 100  :value-date &quot;2014-01-02&quot; :ccy &quot;CHF&quot; :xref &quot;A3&quot;}]})</code></pre>

<p>For updating the data, we assign the defined map to an <em>atom</em> , i.e. a named reference holding our  immutable value and  providing functions to swap one value with another one.  </p>

<pre class="line-numbers"><code class="language-Clojure">(def accounts-data (atom account-test-data))</code></pre>

<p>Second, we need a handler for our interface method. The library <a href="http://clojure-liberator.github.io/liberator/">Liberator</a> implements the REST protocol as per RFC.  Here, we use this library and add the necessary logic for our particular handler. </p>

<pre class="line-numbers"><code class="language-Clojure">(defresource accounts-r [id]
    :available-media-types [&quot;application/json&quot;]
    :allowed-methods [:get]
    :exists? (fn [_]
                 (if-let [acc-j  (get-in @account [(keyword id)])]
                    [true  {:account  acc-j}]
                    [false {:message (format &quot;Account %s not found&quot; id)}]))
    :handle-ok (fn [{acc-j :account}](j/write-str acc-j)))</code></pre>

<p>This resource definition includes a check whether the requested account exists or not and a handler that returns the retrieved account. </p>

<p>Now, we can run on the command line the server and use <code>curl</code> to invoke the service (as soon as the hellow world we-page is showing up). Alternatively, we can also type the URL into the browser.</p>

<pre><code>$ curl -i http://localhost:8000/accounts/101  returns the account object
$ curl -i http://localhost:8000/accounts/1012 returns a 404</code></pre>

<p>At this point, we have a working RESTful interface.  But, the developer of the next interface has to understand the Liberator library. Furthermore, the developer might make different design choices and hence each interface implementaion might be somewhat different. Could we not standardize this resource definition and provide it as a library?</p>

<h3 id="toc_8">A Standardized Re-usable Controller</h3>

<p>For building a re-usabel resource definition, I have to understand first how the MVC design pattern relates to the above code. Second, where to use protocols to decouple the controller.</p>

<p>The MVC pattern resource <em>model</em>,  <em>view</em> and <em>controller</em> correspond   in above code to the <code>atom</code> with the functions on this atom, the reader/writer for JSON , and the <code>defresource</code> form that defines the controller.    </p>

<p>A GET controller has always the same structure, so that I rewrite the above examaple as the following clojure macro (asssuming that this is a good enough one).  </p>

<pre class="line-numbers"><code class="language-Clojure">(defmacro my-r-macro
  [r-name r-id &amp; {:keys [lookup-fn]}]
  `(defresource ~r-name [~r-id]
     :allowed-methods [:get ]
     :known-content-type? #(check-content-type % [&quot;application/json&quot;])
     :exists?
         (fn [_#]
            (if-let [res# (~lookup-fn (keyword ~r-id))]
                true
                [false {:message (format &quot;~r-name %s not found&quot; ~r-id)}]))
     :handle-ok (fn [_#] (j/write-str (~lookup-fn (keyword ~r-id))))))
</code></pre>

<p>With this marcro, the actuual controller definition is simply expressed in terms of the macro, as      </p>

<pre class="line-numbers"><code class="language-Clojure">(my-r-macro accounts-r id
            :lookup-fn lookup-accounts)</code></pre>

<p>This simple macro, requires that we declare the functions used to access the model. This results in unnecessary boiler-plate code. More importantly, the requirements on these functions are not clearly specified.  </p>

<p>To address these short-commings, I introduce a <em>protocol</em> defining the signature to access the resource models. </p>

<pre class="line-numbers"><code class="language-Clojure">    (defprotocol` RM-Accessor
      (get-item [this id])
      (duplicate-item? [this id item])
      (valid-item? [this id item])
      (add-item [this id item]))</code></pre>

<p>This protocol supports also the update of a resource using a <code>POST</code>. Before adding an item, you can determine whether the item is a duplicate and whether it is valid. </p>

<p>I rewrite next the controller macro using the protocol just defined. In above macro example, we replace the <code>~lookup-fn</code> by the protocol function <code>get-item</code>. The latter requires as a first argument a type instance implementing the protocol, wich I will call  <code>r-m</code> - an input gargument of the macro.</p>

<pre class="line-numbers"><code class="language-Clojure">(defmacro defresource-macro  [r-name r-id r-m &amp; {:keys [malformed-fn]}]
      `(defresource ~r-name [~r-id]
         :available-media-types [&quot;application/json&quot;]
         :allowed-methods [:get :post]
         :known-content-type? #(check-content-type % [&quot;application/json&quot;])
         :malformed?
           (fn [{{method# :request-method} :request :as ctx#}]
             (if (= :post method#)
               (try
                (if-let [body# (body-as-string ctx#)]
                  (let [record# (j/read-str body# :key-fn keyword)]
                     (if (~malformed-fn record#)
                       [true  {:message &quot;booking incomplete.&quot;}]
                       (if (not (valid-item? ~r-m ~r-id record#))
                         [true  {:message &quot;invalid entry&quot; }]
                         [false {:record record#}])))
                  [true {:message &quot;No body&quot;}])
              (catch Exception e#

          [true {:message (format &quot;exception: %s&quot; (.getMessage e#))}]))))
    :exists?
        (fn [_#]
           (if-let [res# (get-item ~r-m ~r-id)]
              [true res#]
              [false {:message (format &quot;%s %s not found...&quot; (get-name ~r-m) ~r-id)}]))
    :can-post-to-missing?
         (fn [_#] [false {:message (format &quot;%s %s not found!&quot; (get-name ~r-m) ~r-id)}])
    :post!
         (fn [{record# :record}]
              (if (duplicate-item? ~r-m ~r-id record#)
                [false {:message (format &quot;account booking %s already exists&quot; ~r-id)}]
                [true  {:result (add-item ~r-m ~r-id record#)}]))            
    :location #(build-entry-url (get % :request) )
    :handle-ok (fn [_#] (j/write-str (get-item ~r-m ~r-id)))))
</code></pre>

<p>You mgiht want to compare the rewrite of the functions that define <code>:exists?</code> and <code>:handle-ok</code>.  The additional functions are necessary for the POST method  main methods are:</p>

<ul>
<li><p><code>:malformed?</code> checks whether the request itself is valid. I my implementation, I distinguish between the protocol- and model-specific validation. The former and the latter are carried out by the functions <code>~malformed-fn</code> and the protocl function <code>validate-item</code>. </p></li>
<li><p><code>:post!</code> updates the accounts <code>atom</code> unless the booking item is a duplicate. </p></li>
</ul>

<p>Before I can create an interface using the re-written macro, I have to implement the protocol. Clojure provides <code>deftype</code> and <code>defrecord</code> for implementing types in the implementation and application domain, respectively.</p>

<p>The kind of resource model is defined by a type. As an example, I define <code>DependentRessource</code>, which is suitable to handle bookings given an account identifier. </p>

<pre class="line-numbers"><code class="language-Clojure">(deftype DependentResourceModel [rm-name data schema validation-fn dr-key xref-key]
   RM-Accessor
   (get-item [this id]
      (get-in @data [(keyword id) dr-key]))
   (duplicate-item? [this id item]
      (if (empty? (xref-key item))
        false
       (let [journal (get-in @data [(keyword id) dr-key])
             item-keys (vec
                        (clojure.set/difference
                           (set (keys item)) (set (list xref-key))))]
         (clojure.set/subset?
            (clojure.set/project (set (list item)) item-keys )
            (clojure.set/project (set journal) item-keys)))))
   (valid-item? [this id item]
      (let [obj (get-in @data [(keyword id)])
            v1 (valid-schema? schema item)
            v2 (validation-fn obj item)]
        (and (first v1)(first v2))))
   (add-item [this id item]
      (let [j-item (conj {:time-stamp (l/format-local-time
                                           (l/local-now) :date-time)} item)
            items (get-in @data [(keyword id) dr-key])]
         (swap! data assoc-in [(keyword id) dr-key]
                              (vec (conj items j-item ))))))</code></pre>

<p>This type implements </p>

<ul>
<li><p><code>get-item</code>to retrieve the account bookings (as per parameter <code>dr-key</code>) given the account identifier <code>id</code>; and</p></li>
<li><p><code>add-item</code>to add an account booking <code>item</code> to a particular account <code>id</code>. </p></li>
</ul>

<p>The function  <code>valid-item?</code> checks <code>valid-schema?</code> and <code>validation-fn</code>. The latter checks in our example that the currency of the booking item corresponds to the account currency.  The former checks that a booking item complies with the data shape defined for it.   </p>

<p>For defining data shapes and validation them, I use the <a href="https://github.com/Prismatic/schema">schema</a> library.   </p>

<pre class="line-numbers"><code class="language-Clojure">    (s/defschema account-booking-s
       {:value-date (s/pred value-date? &#39;value-date?)
        :amount s/Num                                 
        :ccy currency-code-s                        
        (s/optional-key :xref)s/Str
        (s/optional-key :ts) s/Str})</code></pre>

<p>Noteworthy is the definition of a predicate <code>value-date?</code> that checks that the value is a string in the format <code>&quot;YYYY-MM-DD&quot;</code> that represents a valid date. Furthermore, I apply first validations only where necessary - here the <code>POST</code>reguest body. Second, the schemata are not imposing type constraints on the implementations. This makes it possible to aim for generic implementations, but constrain their inputs as necessary from a business perspective.   </p>

<p>At this point, we can define our RESTful interface by simply declaring a suitable resource type instance that takes as arguments</p>

<ul>
<li>an atom <code>accounts-data</code> and schema `accounts-booking-s</li>
<li>a <code>booking-validation-fn?</code>; and </li>
<li>the keywords used by the type-specific protocol implementation.</li>
</ul>

<pre class="line-numbers"><code class="language-Clojure">
(def accounts-bookings-r-m
  (DependentResourceModel.  &quot;account-bookings&quot; 
                            accounts-data account-booking-s
                            booking-validation-fn? 
                            :bookings :xref))

(defresource-macro accounts-bookings-r id
            accounts-bookings-r-m
            :malformed-fn malformed-request?)         </code></pre>

<p>This definition is sufficient to implement RESTful interfaces for depenent resources using JSON as media type. Under the hood of this macro, we could replace the REST library or extend the macro to support multiple media types as well as to provide end-points using additional transport protols, such SOAP/HTTPs.</p>

<p>A solution architect designing an application need only to follow <em>&ldquo;Don&rsquo;t Repeat Yourself&rdquo; (DRY)</em> to obtain the here outlined solution.  For instituationalizing such a solution accross a domain or enterprise, one could adopt a community approach or implement integration libararies centrally. </p>

<h2 id="toc_9">Appendix: Background</h2>

<h3 id="toc_10">What is an interface?</h3>

<p>Applictions exchange data through <strong>interfaces</strong>, which offer particular data and functions of an application  as a serice. Interfaces are implemented using different <em>transport protocools</em> including file transfer protocol (ftp), message-passing and synchronous WebServices (WS)  and <em>RESTful</em> interfaces.   </p>

<p>interfaces, any like Application Programming Interfaces (APIs),  provide </p>

<ul>
<li><p>Suitable <em>abstraction</em> over the implementation, which facilitates the usage and encapsulates implementation details.  An abstraction might involve a mappring between different vocabularies, be it an  industry standard vocabulary, an implementation vocabulary, etc. </p></li>
<li><p>Interfaces represent a <em>contract</em>, the interace description specifies the contract terms and conditions.  Furthermore,  this description should be sufficient to use an interace (and hence inspecting the implementation is not necessary).</p></li>
<li><p>Interfaces <em>loosely couple</em> applications by introducing an introdcution: a coupling between the interface implementation to the interface and the interface to the interface consumer (independent of whether one develops interaces using a contract- or code-first approach).  </p></li>
<li><p>Interfaces are <em>versioned</em>, so that an interface can be further develeoped  and the consumers can mgirate over time.</p></li>
</ul>

<h3 id="toc_11">REST</h3>

<h3 id="toc_12">MVC</h3>

<h3 id="toc_13">Macros</h3>

<p>Von meinem iPad gesendet</p>

<script type="text/javascript">
self="undefined"!=typeof window?window:"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?self:{};var Prism=function(){var e=/\blang(?:uage)?-(?!\*)(\w+)\b/i,t=self.Prism={util:{encode:function(e){return e instanceof n?new n(e.type,t.util.encode(e.content),e.alias):"Array"===t.util.type(e)?e.map(t.util.encode):e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/\u00a0/g," ")},type:function(e){return Object.prototype.toString.call(e).match(/\[object (\w+)\]/)[1]},clone:function(e){var n=t.util.type(e);switch(n){case"Object":var a={};for(var r in e)e.hasOwnProperty(r)&&(a[r]=t.util.clone(e[r]));return a;case"Array":return e.map(function(e){return t.util.clone(e)})}return e}},languages:{extend:function(e,n){var a=t.util.clone(t.languages[e]);for(var r in n)a[r]=n[r];return a},insertBefore:function(e,n,a,r){r=r||t.languages;var i=r[e];if(2==arguments.length){a=arguments[1];for(var l in a)a.hasOwnProperty(l)&&(i[l]=a[l]);return i}var s={};for(var o in i)if(i.hasOwnProperty(o)){if(o==n)for(var l in a)a.hasOwnProperty(l)&&(s[l]=a[l]);s[o]=i[o]}return t.languages.DFS(t.languages,function(t,n){n===r[e]&&t!=e&&(this[t]=s)}),r[e]=s},DFS:function(e,n,a){for(var r in e)e.hasOwnProperty(r)&&(n.call(e,r,e[r],a||r),"Object"===t.util.type(e[r])?t.languages.DFS(e[r],n):"Array"===t.util.type(e[r])&&t.languages.DFS(e[r],n,r))}},highlightAll:function(e,n){for(var a,r=document.querySelectorAll('code[class*="language-"], [class*="language-"] code, code[class*="lang-"], [class*="lang-"] code'),i=0;a=r[i++];)t.highlightElement(a,e===!0,n)},highlightElement:function(a,r,i){for(var l,s,o=a;o&&!e.test(o.className);)o=o.parentNode;if(o&&(l=(o.className.match(e)||[,""])[1],s=t.languages[l]),s){a.className=a.className.replace(e,"").replace(/\s+/g," ")+" language-"+l,o=a.parentNode,/pre/i.test(o.nodeName)&&(o.className=o.className.replace(e,"").replace(/\s+/g," ")+" language-"+l);var u=a.textContent;if(u){u=u.replace(/^(?:\r?\n|\r)/,"");var g={element:a,language:l,grammar:s,code:u};if(t.hooks.run("before-highlight",g),r&&self.Worker){var c=new Worker(t.filename);c.onmessage=function(e){g.highlightedCode=n.stringify(JSON.parse(e.data),l),t.hooks.run("before-insert",g),g.element.innerHTML=g.highlightedCode,i&&i.call(g.element),t.hooks.run("after-highlight",g)},c.postMessage(JSON.stringify({language:g.language,code:g.code}))}else g.highlightedCode=t.highlight(g.code,g.grammar,g.language),t.hooks.run("before-insert",g),g.element.innerHTML=g.highlightedCode,i&&i.call(a),t.hooks.run("after-highlight",g)}}},highlight:function(e,a,r){var i=t.tokenize(e,a);return n.stringify(t.util.encode(i),r)},tokenize:function(e,n){var a=t.Token,r=[e],i=n.rest;if(i){for(var l in i)n[l]=i[l];delete n.rest}e:for(var l in n)if(n.hasOwnProperty(l)&&n[l]){var s=n[l];s="Array"===t.util.type(s)?s:[s];for(var o=0;o<s.length;++o){var u=s[o],g=u.inside,c=!!u.lookbehind,f=0,h=u.alias;u=u.pattern||u;for(var p=0;p<r.length;p++){var d=r[p];if(r.length>e.length)break e;if(!(d instanceof a)){u.lastIndex=0;var m=u.exec(d);if(m){c&&(f=m[1].length);var y=m.index-1+f,m=m[0].slice(f),v=m.length,k=y+v,b=d.slice(0,y+1),w=d.slice(k+1),N=[p,1];b&&N.push(b);var O=new a(l,g?t.tokenize(m,g):m,h);N.push(O),w&&N.push(w),Array.prototype.splice.apply(r,N)}}}}}return r},hooks:{all:{},add:function(e,n){var a=t.hooks.all;a[e]=a[e]||[],a[e].push(n)},run:function(e,n){var a=t.hooks.all[e];if(a&&a.length)for(var r,i=0;r=a[i++];)r(n)}}},n=t.Token=function(e,t,n){this.type=e,this.content=t,this.alias=n};if(n.stringify=function(e,a,r){if("string"==typeof e)return e;if("Array"===t.util.type(e))return e.map(function(t){return n.stringify(t,a,e)}).join("");var i={type:e.type,content:n.stringify(e.content,a,r),tag:"span",classes:["token",e.type],attributes:{},language:a,parent:r};if("comment"==i.type&&(i.attributes.spellcheck="true"),e.alias){var l="Array"===t.util.type(e.alias)?e.alias:[e.alias];Array.prototype.push.apply(i.classes,l)}t.hooks.run("wrap",i);var s="";for(var o in i.attributes)s+=o+'="'+(i.attributes[o]||"")+'"';return"<"+i.tag+' class="'+i.classes.join(" ")+'" '+s+">"+i.content+"</"+i.tag+">"},!self.document)return self.addEventListener?(self.addEventListener("message",function(e){var n=JSON.parse(e.data),a=n.language,r=n.code;self.postMessage(JSON.stringify(t.util.encode(t.tokenize(r,t.languages[a])))),self.close()},!1),self.Prism):self.Prism;var a=document.getElementsByTagName("script");return a=a[a.length-1],a&&(t.filename=a.src,document.addEventListener&&!a.hasAttribute("data-manual")&&document.addEventListener("DOMContentLoaded",t.highlightAll)),self.Prism}();"undefined"!=typeof module&&module.exports&&(module.exports=Prism);
</script>
<script type="text/javascript">
Prism.hooks.add("after-highlight",function(e){var n=e.element.parentNode;if(n&&/pre/i.test(n.nodeName)&&-1!==n.className.indexOf("line-numbers")){var t,a=1+e.code.split("\n").length;lines=new Array(a),lines=lines.join("<span></span>"),t=document.createElement("span"),t.className="line-numbers-rows",t.innerHTML=lines,n.hasAttribute("data-start")&&(n.style.counterReset="linenumber "+(parseInt(n.getAttribute("data-start"),10)-1)),e.element.appendChild(t)}});
</script>
<script type="text/x-mathjax-config">
if (typeof MathJaxListener !== 'undefined') {
  MathJax.Hub.Register.StartupHook('End', function () {
    MathJaxListener.invokeCallbackForKey_('End');
  });
}
</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>

</html>
